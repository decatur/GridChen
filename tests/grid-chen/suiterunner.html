<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Suite Runner</title>
    <link rel="stylesheet" href="../../demo.css">
    <script src="../../theme.js"></script>
</head>
<body>

<h1><a href="../../index.html">Index</a> / Test Suite Runner</h1>

<button id="runAllTests">Run all tests</button>

<grid-chen style="display: block; height: 300px; margin: 1em;"></grid-chen>

</body>

<script type="module">
    /*
     * ### Test Execution Design
     * 0. No dependencies.
     * 1. Test modules are loaded and executed complete independent of each other.
     * 2. In generated iframes access to the clipboard is restricted. So we use a new browser window, not an iframe.
     * 3. We rely on the given browser functionality such as 'Close Other Tabs'
     */
    import "../../grid-chen/webcomponent.js"
    import {createView} from "../../grid-chen/matrixview.js"
    import {modules} from "../modules.js"

    let modulesToRun;

    function nextModule() {
        window.open('testrunner.html?module=' + modulesToRun[0]);
    }

    // Register callback through window.opener.
    window.moduleDone = function (moduleName) {
        const index = modulesToRun.indexOf(moduleName);
        modulesToRun.splice(index, 1);
        if (modulesToRun.length) {
            nextModule();
        }
    };

    const schema = {
        title: 'Test Suite',
        type: 'array',
        items: {
            type: 'array',
            items: [
                {title: 'Run Single Test', type: 'string', format: 'uri', width: 200}
            ]
        }
    };

    /** @type {GridChenNS.GridChen} */
    const gridChen = document.querySelector('grid-chen');
    gridChen.resetFromView(createView(schema, modules.map(moduleName => ['#' + moduleName])));

    document.getElementById('runAllTests').onclick = function () {
        modulesToRun = Object.assign([], modules);
        nextModule();
    };

    window.onhashchange = function () {
        modulesToRun = [window.location.hash.substr(1)];
        nextModule();
    };

</script>
</html>